language: cpp
sudo: required

addons:
    apt:
        sources:
            - ubuntu-toolchain-r-test
        packages:
            - gcc-9
            - g++-9

stages:
  - build and test

jobs:
  include:
      # Linux 64-bit
    - stage: build and test
      name: Linux 64-bit
      os: linux
      install: &install_linux
        - sudo unlink /usr/bin/gcc && sudo ln -s /usr/bin/gcc-9 /usr/bin/gcc
        - sudo unlink /usr/bin/g++ && sudo ln -s /usr/bin/g++-9 /usr/bin/g++
        - wget https://github.com/Kitware/CMake/releases/download/v3.15.0-rc3/cmake-3.15.0-rc3-Linux-x86_64.tar.gz
        - tar -xf cmake-3.15.0-rc3-Linux-x86_64.tar.gz
        - sudo ln -s ${TRAVIS_BUILD_DIR}/cmake-3.15.0-rc3-Linux-x86_64/bin/cmake /home/travis/bin/cmake
        - sudo ln -s ${TRAVIS_BUILD_DIR}/cmake-3.15.0-rc3-Linux-x86_64/bin/ctest /home/travis/bin/ctest
      env: &linux-64-toolchain
        - TOOLCHAIN=""
      script: &script_linux
        - mkdir build && cd build
        - cmake ${TOOLCHAIN} ..
        - make all
        - ctest --verbose

      # Linux 32-bit
    - stage: build and test
      name: Linux 32-bit
      os: linux
      install: *install_linux
      before_script: &before-script-linux32
        - sudo apt-get install -y gcc-9-multilib
        - sudo apt-get install -y g++-9-multilib
        - sudo apt-get install -y linux-libc-dev:i386
      script: *script_linux
      env: &linux-32-toolchain
        - TOOLCHAIN="x86-toolchain.cmake"

      # Windows 64-bit
    - stage: build and test
      name: Windows 64-bit
      os: windows
      install: &install_windows
        - choco upgrade cmake
      env: &windows-64-toolchain
        - ARCH=" Win64"
      script: &script_windows
        - mkdir build && cd build
        - cmake -G "Visual Studio 15 2017${ARCH}" ..
        - cmake --build .
        - ctest --verbose

      # Windows 32-bit
    - stage: build and test
      name: Windows 32-bit
      os: windows
      install: *install_windows
      env: &windows-32-toolchain
        - ARCH=""
      script: *script_windows
